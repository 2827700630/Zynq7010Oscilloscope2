# AD9280_SCOP_2.0 IP核版本验证功能说明

## 🎯 功能概述

在REG7 (0x1C) 中存储IP核版本信息，软件启动时自动验证硬件版本，确保IP核已正确升级。

## 📋 硬件修改

### 1. 版本信息定义 (ad9280_scop.v)
```verilog
// IP Core Version Information (for REG7)
// Version format: {Major[7:0], Minor[7:0], Patch[7:0], Build[7:0]}
localparam [31:0] IP_VERSION = {8'd2, 8'd4, 8'd0, 8'd1};  // Version 2.4.0.1
// Major: 2 (ad9280_scop_2.x)
// Minor: 4 (升级版本)  
// Patch: 0 (补丁版本)
// Build: 1 (构建编号)

// Version register assignment
assign reserved_reg = IP_VERSION;  // 将版本信息赋值给REG7
```

### 2. REG7只读配置 (ad9280_scop_slave_lite_v2_0_S00_AXI.v)
- REG7设置为只读寄存器，不允许软件写入
- 复位时从外部版本信息更新
- 写操作被忽略

## 🔧 软件功能

### 1. 版本信息结构体
```c
typedef struct {
    u8 major;    // 主版本号 (2)
    u8 minor;    // 次版本号 (4) 
    u8 patch;    // 补丁版本 (0)
    u8 build;    // 构建编号 (1)
} ip_version_t;
```

### 2. 版本验证函数
```c
// 获取IP核版本
ip_version_t ad9280_get_ip_version(u32 adc_addr);

// 验证版本匹配
int ad9280_verify_ip_version(u32 adc_addr);

// 打印版本信息
void ad9280_print_ip_version(u32 adc_addr);
```

### 3. 自动版本检查
- 在 `ad9280_comprehensive_init()` 函数开始时自动检查
- 版本不匹配时返回错误，阻止后续初始化
- 详细的版本信息输出和诊断

## 📊 版本格式说明

### REG7寄存器位分配 (0x1C)
```
bit[31:24] - 主版本号 (Major)    : 2
bit[23:16] - 次版本号 (Minor)    : 4  
bit[15:8]  - 补丁版本 (Patch)    : 0
bit[7:0]   - 构建编号 (Build)    : 1
```

### 当前版本定义
- **版本号**: 2.4.0.1
- **REG7值**: 0x02040001
- **含义**: ad9280_scop_2第4次升级版本，无补丁，第1次构建

## 🔍 使用示例

### 1. 启动时版本检查
```c
// 在ADC初始化前检查版本
ad9280_print_ip_version(AD9280_BASE);
if (!ad9280_verify_ip_version(AD9280_BASE)) {
    xil_printf("❌ IP核版本不匹配 - 需要升级硬件！\r\n");
    return XST_FAILURE;
}
```

### 2. 预期输出示例
```
=== IP核版本信息 ===
版本寄存器 (REG7): 0x02040001
IP核版本: 2.4.0.1
期望版本: 2.4.0.1
✅ IP核版本验证通过
===================
```

### 3. 版本不匹配输出
```
=== IP核版本信息 ===
版本寄存器 (REG7): 0x02030000
IP核版本: 2.3.0.0
期望版本: 2.4.0.1
❌ IP核版本不匹配 - 需要升级硬件！
  次版本过低: 当前3, 期望>=4
===================
```

## ⚡ 验证流程

### 1. 硬件升级后验证
1. 重新打包IP核 (版本号2.3→2.4)
2. 升级Block Design中的IP实例
3. 重新综合、实现、生成bitstream
4. 导出XSA，更新Vitis平台
5. 重新编译软件
6. 烧录运行，观察版本检查输出

### 2. 预期结果
- ✅ **旧硬件**: REG7=0x02030000，版本检查失败
- ✅ **新硬件**: REG7=0x02040001，版本检查通过
- ✅ **连续采样**: sampling_active=1，AXI Stream正常输出

## 🎯 关键优势

1. **自动验证**: 软件启动时自动检查硬件版本
2. **明确诊断**: 详细的版本信息和错误提示
3. **防止错误**: 版本不匹配时阻止初始化，避免异常行为
4. **调试友好**: 清晰的版本输出，便于问题定位
5. **向前兼容**: 支持次版本号升级检查

## 📝 注意事项

1. **只读寄存器**: REG7为只读，软件无法修改
2. **版本递增**: 每次IP核修改都应该递增版本号
3. **兼容性检查**: 主版本必须匹配，次版本必须大于等于期望值
4. **错误处理**: 版本不匹配时应终止初始化流程

---
**创建时间**: $(Get-Date)  
**版本**: 2.4.0.1  
**功能**: IP核版本自动验证  
**状态**: 已实现，待硬件升级验证
