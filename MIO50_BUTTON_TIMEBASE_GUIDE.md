# MIO50按键时基切换功能 - 使用说明

## 📋 功能概述

为Zynq示波器添加了基于MIO50按键的手动时基切换功能，用户可以通过按键在5个时基档位间循环切换，实现专业示波器的操作体验。

## 🔧 硬件连接

### 按键连接
- **引脚**: MIO50
- **电路**: 按键一端接MIO50，另一端接GND
- **上拉**: MIO50内部上拉到3.3V
- **逻辑**: 
  - 按键未按下：MIO50 = 高电平 (1)
  - 按键按下：MIO50 = 低电平 (0)

### 连接示意图
```
3.3V ──[上拉电阻]── MIO50 ──[按键]── GND
                      │
                   GPIO输入
```

## 🎛️ 软件实现

### 1. GPIO驱动配置
```c
#include "xgpiops.h"  // ZYNQ PS GPIO驱动

#define GPIO_DEVICE_ID XPAR_XGPIOPS_0_DEVICE_ID
#define BUTTON_MIO_PIN 50                   // 时基切换按键
#define BUTTON_PRESS_LOW 0                  // 按下=低电平
#define BUTTON_RELEASE_HIGH 1               // 释放=高电平
#define DEBOUNCE_DELAY_MS 50               // 防抖延时
```

### 2. 按键检测算法
- **防抖处理**: 连续3次检测到相同状态才确认状态变化
- **边沿检测**: 只在按键从高电平变为低电平时触发
- **避免连续触发**: 按键释放后才能再次触发

### 3. 时基切换逻辑
- **循环切换**: 档位1 → 2 → 3 → 4 → 5 → 1 → ...
- **即时生效**: 按键按下后立即切换时基并更新显示
- **状态提示**: 通过串口输出当前时基档位信息

## 📊 时基档位表

| 档位 | 抽取比例 | 时基 | 适用场景 | 按键次数 |
|------|----------|------|----------|----------|
| 1    | 1:1      | 5μs/格 | 高频信号细节 | 按1次 |
| 2    | 2:1      | 10μs/格 | 快速脉冲 | 按2次 |
| 3    | 4:1      | 20μs/格 | 中频数字信号 | 按3次(初始) |
| 4    | 5:1      | 30μs/格 | 标准数字信号 | 按4次 |
| 5    | 8:1      | 50μs/格 | 慢速数字信号 | 按5次 |

## 🚀 操作方法

### 基本操作
1. **系统启动**: 默认时基档位3 (20μs/格)
2. **切换时基**: 短按MIO50按键切换到下一档位
3. **循环切换**: 到达档位5后再按键回到档位1
4. **状态确认**: 通过串口查看切换确认信息

### 操作示例
```
[按键] 手动切换到时基档位: 4   ← 按键切换到30μs/格
[按键] 手动切换到时基档位: 5   ← 按键切换到50μs/格  
[按键] 手动切换到时基档位: 1   ← 按键切换到5μs/格(循环)
```

## 📱 系统行为

### 1. 初始化过程
```
GPIO Initialization Success              ← GPIO初始化成功
[GPIO] MIO50配置为时基切换按键输入      ← 按键配置完成
[时基] 初始化为档位3: 20us/格           ← 默认时基设置
[主循环] 开始实时波形显示循环           ← 系统就绪
```

### 2. 按键检测时序
- **检测频率**: 每10帧检测一次 (约166ms间隔)
- **防抖时间**: 30ms (连续3次检测)
- **按键延时**: 按下后延时200ms避免连续触发

### 3. 响应特性
- **响应时间**: < 200ms
- **防误触**: 有效防抖处理
- **状态一致**: 按键状态与显示状态同步

## 🔧 高级功能

### 自动演示模式（可选）
```c
static u8 auto_demo_enabled = 0; // 0=关闭，1=开启
```
- 可通过修改代码启用自动演示
- 自动模式下每5秒切换一次时基
- 手动按键操作优先级更高

### 扩展功能建议
1. **长按功能**: 长按3秒切换自动/手动模式
2. **多按键**: 添加更多MIO引脚实现其他功能
3. **状态LED**: 用LED指示当前时基档位
4. **OLED显示**: 在屏幕上显示当前时基信息

## ⚡ 性能特点

### 优点
- ✅ **实时响应**: 按键响应快速，用户体验良好
- ✅ **稳定可靠**: 完善的防抖处理，避免误触发
- ✅ **资源占用小**: 仅使用一个GPIO引脚和少量代码
- ✅ **专业体验**: 符合传统示波器的操作习惯

### 技术特性
- **防抖算法**: 软件防抖，无需外部硬件
- **边沿检测**: 只在按下动作时触发
- **状态管理**: 完整的按键状态机
- **错误处理**: GPIO初始化失败时有错误提示

## 🐛 故障排除

### 常见问题
1. **按键无响应**: 
   - 检查MIO50硬件连接
   - 确认GPIO初始化成功
   
2. **连续触发**: 
   - 检查按键硬件是否有抖动
   - 调整防抖延时参数

3. **切换不准确**:
   - 检查串口输出确认切换状态
   - 验证时基显示是否正确

### 调试方法
```c
// 在CheckButtonPress函数中添加调试输出
xil_printf("[调试] 按键状态: %d\r\n", current_state);
```

## 📈 未来改进方向

1. **多功能按键**: 支持短按、长按、双击等操作
2. **触摸屏控制**: 结合触摸屏实现图形化时基选择
3. **旋转编码器**: 使用编码器实现更精确的时基调节
4. **远程控制**: 通过串口命令远程切换时基

## 🎉 总结

MIO50按键时基切换功能为Zynq示波器提供了：
- ✅ **专业操作体验**: 真正的硬件按键控制
- ✅ **实时切换能力**: 观测信号时无需中断
- ✅ **简单易用**: 单按键循环切换，操作直观
- ✅ **稳定可靠**: 完善的软件防抖和错误处理

现在您的示波器具备了专业级的时基切换控制功能！
