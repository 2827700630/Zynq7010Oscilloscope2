# Zynq7010 示波器触发系统说明

## 概述

本项目实现了一个基于Zynq7010 FPGA的示波器系统，具有智能软件触发功能。触发系统能够稳定显示波形，支持时基切换和触发电平调节。

## 硬件架构

### ADC采集系统
- **ADC芯片**: AD9280 (8位，32.26MHz采样率)
- **前端调理**: AD8056运算放大器衰减电路
- **输入范围**: -5V ~ +5V (10Vpp)
- **转换关系**: VAD = (1/5)VIN + 1
- **ADC输入**: 0V ~ 2V，对应ADC码值 0~255

### 缓冲区配置
- **主采样缓冲区**: 15360个采样点
- **显示缓冲区**: 1920个显示点（屏幕宽度）
- **DMA传输**: S2MM模式，中断驱动

## 触发系统工作原理

### 数据流程

1. **ADC采集**: 采集15360个原始采样点到主缓冲区
2. **波形范围检测**: 计算波形的最大值和最小值
3. **触发条件判断**: 检查触发电平是否在波形范围内
4. **触发点搜索**: 如果条件满足，搜索上升沿触发点
5. **显示窗口提取**: 以触发点为中心提取显示数据
   - 前960点（预触发）
   - 后960点（后触发）
   - 总计1920显示点
6. **时基抽取**: 根据当前时基进行数据抽取
7. **波形显示**: 在1920×1080屏幕上显示稳定波形

### 触发算法

#### 上升沿检测
```c
// 触发条件：从低于(trigger_level - hysteresis)到高于trigger_level
if (prev_val < (trigger_level - hysteresis) && curr_val >= trigger_level) {
    // 找到触发点
    return trigger_point_index;
}
```

#### 智能触发判断
- **范围内触发**: 触发电平在波形范围内时执行触发搜索
- **自动显示**: 触发电平超出范围时直接显示波形中间部分
- **滞后比较**: 使用2个ADC码值的滞后减少噪声影响

### 触发状态

| 状态 | 显示 | 颜色 | 说明 |
|------|------|------|------|
| TRIGGERED | TRIG | 绿色 | 找到触发点，波形稳定显示 |
| WAITING | WAIT | 黄色 | 等待触发或触发电平超出范围 |
| TIMEOUT | AUTO | 红色 | 触发超时（当前未使用） |

## 时基系统

### 时基档位配置

| 档位 | 抽取比例 | 时间/格 | 有效采样率 |
|------|----------|---------|------------|
| 1 | 1x | 5.0μs/格 | 32.26MHz |
| 2 | 2x | 10.0μs/格 | 16.13MHz |
| 3 | 4x | 20.0μs/格 | 8.07MHz |
| 4 | 6x | 30.0μs/格 | 5.38MHz |
| 5 | 8x | 40.0μs/格 | 4.03MHz |

### 抽取算法
```c
// 根据时基抽取比例计算显示数据
for (u32 i = 0; i < display_length; i++) {
    u32 master_index = start_point + (i * decimation_ratio);
    if (master_index < master_length) {
        display_buffer[i] = master_buffer[master_index];
    } else {
        display_buffer[i] = 0; // 超出范围填充0
    }
}
```

## 用户控制接口

### 按键控制

#### MIO50 - 时基切换
- **功能**: 循环切换5档时基
- **操作**: 每次按下切换到下一档位
- **防抖**: 50ms防抖延时
- **提示**: 串口输出当前时基信息

#### MIO51 - 触发电平调节
- **功能**: 调节触发电压
- **默认值**: -1V（ADC码值102）
- **调节步长**: ±1V（对应±26个ADC码值）
- **调节范围**: -5V到+5V
- **循环**: 到达边界后循环到另一端
- **提示**: 串口输出当前触发电压

### 电压转换对照表

| 输入电压VIN | AD电压VAD | ADC码值 | 说明 |
|------------|----------|---------|------|
| -5V | 0V | 0 | 最小值 |
| -1V | 0.8V | 102 | 默认触发电压 |
| 0V | 1V | 128 | 中点 |
| +1V | 1.2V | 153 | +1V |
| +5V | 2V | 255 | 最大值 |

## 显示系统

### 屏幕分辨率
- **显示分辨率**: 1920×1080
- **网格系统**: 16×10主网格
- **网格间距**: 120×108像素

### 信息面板显示
- 时基: μs/格
- 电压档位: V/格
- 频率: Hz/kHz/MHz
- 电压峰峰值: V
- 采样率: Hz/kHz/MHz
- 触发信息: 电压值 + 状态

### 触发指示线
- **颜色**: 红色虚线
- **位置**: 对应触发电平的Y坐标
- **标记**: 屏幕右侧显示触发电压值

## 文件结构

```
src/
├── main.c                 # 主程序，按键控制，触发电平调节
├── adc_dma_ctrl.c        # ADC/DMA控制，触发功能实现
├── adc_dma_ctrl.h        # 头文件定义
└── wave/
    ├── oscilloscope_text.c    # 显示功能，网格，信息面板
    ├── oscilloscope_text.h    # 常量定义，结构体
    ├── oscilloscope_interface.c  # 界面绘制
    └── wave.c               # 波形绘制
```

## 关键函数说明

### 触发相关函数
- `find_trigger_point()`: 在数据中搜索触发点
- `apply_software_trigger()`: 应用触发逻辑，提取显示数据
- `adjust_trigger_level()`: 调节触发电平
- `set_trigger_voltage()`: 直接设置触发电压

### 时基相关函数
- `set_timebase()`: 设置时基档位
- `extract_samples_uniform()`: 均匀抽取采样数据
- `switch_timebase()`: 时基切换控制

### 显示相关函数
- `draw_trigger_level_indicator()`: 绘制触发电平指示线
- `draw_oscilloscope_info()`: 绘制信息面板
- `draw_grid_labels()`: 绘制网格标签

## 调试功能

### 串口输出
- 触发状态信息（每50帧）
- 按键操作提示
- 系统初始化状态
- 频率测量结果

### 性能监控
- 帧率统计
- DMA传输状态
- 触发成功率
- 波形质量指标

## 使用说明

1. **连接硬件**: 将信号源连接到ADC输入
2. **启动系统**: 上电后系统自动初始化
3. **时基调节**: 使用MIO50按键选择合适的时基
4. **触发调节**: 使用MIO51按键调节触发电平
5. **观察波形**: 在HDMI显示器上观察稳定的波形

## 技术特点

- **智能触发**: 自动判断触发条件有效性
- **稳定显示**: 基于触发点的波形稳定算法
- **实时性能**: 硬件DMA + 软件触发的高效组合
- **用户友好**: 直观的按键控制和状态显示
- **可扩展性**: 模块化设计，易于功能扩展

## 版本信息

- **版本**: v1.0
- **日期**: 2025年6月
- **平台**: Zynq7010
- **开发工具**: Vivado 2025.1 + Vitis 2025.1
